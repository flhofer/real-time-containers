name: C/C++ CI

on: 
  push:
    branches: # Run when pushed to develop and master
      - master
      - develop
        
  schedule:
    - cron: "0 2 * * 0" # Run at 2am UTC on Sun

jobs:
  build_and_test:

    runs-on: ubuntu-22.04
          
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
            sudo apt-get update \
            && sudo apt-get install -y gcc make git check libsubunit-dev libjson-c-dev libnuma-dev libcap-dev libgsl-dev libgsl-dbg

    - name: "Build Orchestrator"
      run: make orchestrator
      env: 
        DEBUG: ${{ !endsWith(github.ref, '/master') }}
      
    - name: "Build Use cases"
      run: make usecases
      env: 
        DEBUG: ${{ !endsWith(github.ref, '/master') }}

    - name: Build test code - libcheck
      run: make test

    - name: Move binaries to new folder
      run: |
        mkdir bin \
        && mv orchestrator check_test DataGenerator WorkerApp bin/

    - name: Upload result for job
      uses: actions/upload-artifact@v1
      with:
        name: binaries
        path: bin/

  test_containers:

    runs-on: ubuntu-22.04
          
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: "Build distro containers"
      run: cd tools ; ./container_build.sh; cd ..
      
    - name: "Build ubuntu runner container"
      run: docker build -t ubuntusched tools/.
      

